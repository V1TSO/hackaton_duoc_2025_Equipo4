import { supabase } from './supabase'


interface AuthUser {
  id: string
  email: string
  firstName?: string
  lastName?: string
  age?: number
  role: 'admin' | 'user'
}

export class SupabaseAuth {
  private currentUser: AuthUser | null = null

  async register(userData: {
    email: string
    password: string
    firstName: string
    lastName: string
    age: number
  }) {
    try {
# Ver las últimas líneas
tail -5 src/lib/auth.ts
      const { data, error } = await supabase.auth.signUp({
        email: userData.email,
        password: userData.password,
        options: {
          data: {
            first_name: userData.firstName,
            last_name: userData.lastName,
            age: userData.age,
          }
        }
      })

      if (error) throw error

      return {
        success: true,
        user: data.user,
        message: 'Registro exitoso. Revisa tu email para confirmar tu cuenta.'
      }
    } catch (error: any) {
      console.error('Registration error:', error)
      return {
        success: false,
        error: error.message || 'Error al crear la cuenta'
      }
    }
  }

  async login(email: string, password: string) {
    try {
      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password,
      })

      if (error) throw error

      if (data.user && data.session) {
        this.currentUser = {
          id: data.user.id,
          email: data.user.email!,
          firstName: data.user.user_metadata?.first_name,
          lastName: data.user.user_metadata?.last_name,
          age: data.user.user_metadata?.age,
          role: email.includes('admin') ? 'admin' : 'user'
        }

        return {
          success: true,
          user: this.currentUser,
          session: data.session
        }
      }

      throw new Error('No se pudo iniciar sesión')
    } catch (error: any) {
      console.error('Login error:', error)
      return {
        success: false,
        error: error.message || 'Credenciales inválidas'
      }
    }
  }

  async logout() {
    try {
      const { error } = await supabase.auth.signOut()
      if (error) throw error

      this.currentUser = null
      return { success: true }
    } catch (error: any) {
      console.error('Logout error:', error)
      return {
        success: false,
        error: error.message || 'Error al cerrar sesión'
      }
    }
  }

  async getCurrentUser(): Promise<AuthUser | null> {
    try {
      const { data: { user }, error } = await supabase.auth.getUser()
      
      if (error || !user) {
        this.currentUser = null
        return null
      }

      this.currentUser = {
        id: user.id,
        email: user.email!,
        firstName: user.user_metadata?.first_name,
        lastName: user.user_metadata?.last_name,
        age: user.user_metadata?.age,
        role: user.email?.includes('admin') ? 'admin' : 'user'
      }

      return this.currentUser
    } catch (error) {
      console.error('Get current user error:', error)
      this.currentUser = null
      return null
    }
  }

  isAuthenticated(): boolean {
    return this.currentUser !== null
  }

  onAuthStateChange(callback: (user: AuthUser | null) => void) {
    return supabase.auth.onAuthStateChange(async (event, session) => {
      if (session?.user) {
        this.currentUser = {
          id: session.user.id,
          email: session.user.email!,
          firstName: session.user.user_metadata?.first_name,
          lastName: session.user.user_metadata?.last_name,
          age: session.user.user_metadata?.age,
          role: session.user.email?.includes('admin') ? 'admin' : 'user'
        }
        callback(this.currentUser)
      } else {
        this.currentUser = null
        callback(null)
      }
    })
  }
}

export const auth = new SupabaseAuth()
export const auth = new SupabaseAuth()
